<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: Arial, sans-serif;
            z-index: 1000;
        }
        #status {
            margin-top: 20px;
            font-size: 16px;
            text-align: center;
            padding: 0 20px;
        }
        #error-msg {
            color: #ff4444;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
            font-size: 14px;
        }
        .spinner {
            border: 4px solid #333;
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #skip-btn {
            margin-top: 30px;
            padding: 10px 20px;
            background: #444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        #skip-btn:hover {
            background: #666;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="spinner"></div>
        <div id="status">Chargement de MindAR...</div>
        <div id="error-msg"></div>
        <button id="skip-btn" style="display: none;">Forcer le démarrage</button>
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./assets/targets-cpge.mind; autoStart: false; filterMinCF: 0.0001; filterBeta: 0.001;" 
        embedded 
        color-space="sRGB" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false">
        
        <a-assets timeout="10000">
            <!-- Chargement conditionnel des assets -->
        </a-assets>

        <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-plane color="#00FF00" position="0 0 0" height="0.5" width="0.5" rotation="0 0 0"></a-plane>
            <a-text value="AR fonctionne!" position="0 0.3 0" color="#000" align="center" scale="0.5 0.5 0.5"></a-text>
        </a-entity>
    </a-scene>

    <script>
        const statusDiv = document.querySelector('#status');
        const errorDiv = document.querySelector('#error-msg');
        const loadingScreen = document.querySelector('#loading-screen');
        const skipBtn = document.querySelector('#skip-btn');
        const sceneEl = document.querySelector('a-scene');
        
        let startAttempted = false;
        let loadingTimeout;

        function updateStatus(msg) {
            console.log('[STATUS]', msg);
            statusDiv.textContent = msg;
        }

        function showError(msg) {
            console.error('[ERROR]', msg);
            errorDiv.innerHTML = `❌ ${msg}<br><br>Vérifications:<br>
            • Le fichier targets-cpge.mind existe dans ./assets/ ?<br>
            • Vous êtes en HTTPS ou localhost ?<br>
            • La console montre des erreurs ?`;
            skipBtn.style.display = 'block';
        }

        function hideLoading() {
            clearTimeout(loadingTimeout);
            loadingScreen.style.display = 'none';
        }

        // Timeout de sécurité à 10 secondes
        loadingTimeout = setTimeout(() => {
            if (!startAttempted) {
                showError('Le fichier targets-cpge.mind ne se charge pas');
            } else {
                showError('MindAR ne démarre pas (timeout 10s)');
            }
        }, 10000);

        // 1. Vérifier le fichier .mind
        updateStatus('Vérification du fichier targets-cpge.mind...');
        
        fetch('./assets/targets-cpge.mind', { method: 'HEAD' })
            .then(response => {
                if (!response.ok) throw new Error('Fichier introuvable');
                updateStatus('✓ Fichier .mind trouvé');
                return checkCamera();
            })
            .catch(err => {
                showError(`Fichier ./assets/targets-cpge.mind introuvable`);
            });

        // 2. Vérifier l'accès caméra
        function checkCamera() {
            updateStatus('Demande d\'accès à la caméra...');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    updateStatus('✓ Accès caméra accordé');
                    stream.getTracks().forEach(track => track.stop());
                    return initScene();
                })
                .catch(err => {
                    showError('Accès caméra refusé. Autorisez la caméra et rechargez.');
                });
        }

        // 3. Initialiser la scène
        function initScene() {
            updateStatus('Initialisation de la scène A-Frame...');

            sceneEl.addEventListener('loaded', () => {
                updateStatus('✓ Scène chargée, démarrage MindAR...');
                startMindAR();
            });

            // Si la scène est déjà chargée
            if (sceneEl.hasLoaded) {
                updateStatus('✓ Scène déjà chargée, démarrage MindAR...');
                startMindAR();
            }
        }

        // 4. Démarrer MindAR
        function startMindAR() {
            startAttempted = true;
            
            const arSystem = sceneEl.systems['mindar-image-system'];
            
            if (!arSystem) {
                showError('Système MindAR introuvable (script non chargé?)');
                return;
            }

            updateStatus('Démarrage du tracking AR...');

            arSystem.start().then(() => {
                clearTimeout(loadingTimeout);
                updateStatus('✓ MindAR actif! Pointez vers votre marqueur.');
                
                setTimeout(() => {
                    hideLoading();
                }, 1000);
                
            }).catch(err => {
                showError(`Erreur MindAR: ${err.message || err}`);
                console.error('Erreur complète:', err);
            });
        }

        // Bouton pour forcer le démarrage
        skipBtn.addEventListener('click', () => {
            console.log('[FORCE] Tentative de démarrage forcé');
            hideLoading();
            if (!startAttempted) {
                startMindAR();
            }
        });

        // Log toutes les erreurs
        window.addEventListener('error', (e) => {
            console.error('[WINDOW ERROR]', e.message, e.filename, e.lineno);
        });

        sceneEl.addEventListener('arError', (e) => {
            console.error('[AR ERROR]', e.detail);
            showError('Erreur AR: ' + JSON.stringify(e.detail));
        });

        sceneEl.addEventListener('arReady', () => {
            console.log('[AR READY] MindAR est prêt');
        });
    </script>
</body>
</html>
<!--
                                                            ZONE DE DECOUPAGE 








<a-image src="#frise" material="blending: subtractive" position="0.01741 0.977 0.04519" rotation="-89.99047017663248 0 0" scale="1.98057 1.07929 1"></a-image>






































<!DOCTYPE html>
<html lang="fr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
        AFRAME.registerComponent('play-on-look', {
            schema: { video: { type: 'selector' } },
            init: function () {
                const vid = this.data.video;
                const el = this.el;

                el.addEventListener('mouseenter', () => {
                    if (vid) vid.play();
                });

                el.addEventListener('mouseleave', () => {
                    if (vid) vid.pause();
                });
            }
        });
    </script>
    
    <style>
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            z-index: 1000;
        }
        #error-msg {
            color: red;
            margin-top: 20px;
            max-width: 80%;
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div>Chargement...</div>
        <div id="status" style="margin-top: 20px; font-size: 14px;"></div>
        <div id="error-msg"></div>
    </div>

  
    <div id="startAudio" 
         style="position: fixed; top:0; left:0; width:100%; height:100%; background:black; color:white; display:none; justify-content:center; align-items:center; font-size:28px; cursor:pointer; z-index: 999;">
        Cliquer pour commencer
    </div>

    <a-scene 
        mindar-image="imageTargetSrc: ./assets/targets-cpge.mind; autoStart: false; uiScanning: #my-ui-scanning; uiLoading: no; uiError: no;" 
        embedded 
        color-space="sRGB" 
        vr-mode-ui="enabled: false" 
        device-orientation-permission-ui="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true;">
        
        <a-assets timeout="30000">
            <a-asset-item id="table" src="assets/object/classic_round_side_table.glb"></a-asset-item>
            <a-asset-item id="mobile1" src="assets/object/mobile1.glb"></a-asset-item>
            <a-asset-item id="mobile2" src="assets/object/mobile2.glb"></a-asset-item>
            <a-asset-item id="mobile3" src="assets/object/mobile3.glb"></a-asset-item>
            
            <img id="frise" src="assets/object/frise.jpg">

            <video id="video1" src="assets/films/Temoin1extra.mp4" playsinline crossorigin="anonymous" preload="metadata"></video>
            <video id="video2" src="assets/films/Temoin2extra.mp4" playsinline crossorigin="anonymous" preload="metadata"></video>
            <video id="video3" src="assets/films/Temoin3extra.mp4" playsinline crossorigin="anonymous" preload="metadata"></video>
        </a-assets>

        <a-entity mindar-image-camera>
            <a-entity id="cursor" 
                      cursor="fuse: true; fuseTimeout: 800" 
                      raycaster="objects: .playable; far: 20" 
                      position="0 0 -1" 
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03" 
                      material="shader: flat; color: #ff1111">
            </a-entity>
        </a-entity>

        <a-entity mindar-image-target="targetIndex: 0">
            <a-entity id="global" position="0 0 0">
                <a-image src="#frise" position="0 0.5 0" scale="1.5 1.5 1"></a-image>
                
                <a-entity gltf-model="#table" scale="1.27891 0.23741 1.22012" position="0 0.86 0"></a-entity>

                <a-entity position="0 0.33 0" scale="0.5 0.5 0.5">
                    
                    <a-entity id="tel1+video3">
                        <a-entity id="telephone1" gltf-model="#mobile1" scale="0.1 0.08 0.1" position="-0.05 1.83 0.28" rotation="0 -56.7 0"></a-entity>
                        <a-video 
                            class="playable" 
                            play-on-look="video: #video3" 
                            src="#video3" 
                            width="16" 
                            height="9" 
                            position="-0.08441 1.798 0.29972" 
                            rotation="0 -56.87580144925143 0" 
                            scale="0.03417 0.08137 0.1">
                        </a-video>
                    </a-entity>

                    <a-entity id="tel2+video1">
                        <a-entity id="telephone2" gltf-model="#mobile2" scale="0.01 0.01 0.01" position="0.096 1.87 -0.05"></a-entity>
                        <a-video 
                            class="playable" 
                            play-on-look="video: #video1" 
                            src="#video1" 
                            width="16" 
                            height="9" 
                            position="0.10304 1.80643 -0.04651" 
                            scale="0.02967 0.10104 0.1">
                        </a-video>
                    </a-entity>

                    <a-entity id="tel3+video2">
                        <a-entity id="telephone3" gltf-model="#mobile3" scale="0.5 0.5 0.39" position="0.48 1.82 0.40" rotation="90 -120 0"></a-entity>
                        <a-video 
                            class="playable" 
                            play-on-look="video: #video2" 
                            src="#video2" 
                            width="16" 
                            height="9" 
                            position="0.30405 1.81499 0.30805" 
                            rotation="0 59.64000000000001 0" 
                            scale="0.03591 0.10571 0.1">
                        </a-video>
                    </a-entity>
                </a-entity>
            </a-entity>
        </a-entity>
    </a-scene>

    <div id="my-ui-scanning" style="display: none;"></div>

    <script>
        const statusDiv = document.querySelector('#status');
        const errorDiv = document.querySelector('#error-msg');
        const loadingScreen = document.querySelector('#loading-screen');
        const startAudio = document.querySelector('#startAudio');
        
        let loadingTimeout;

        // Diagnostic de chargement
        function updateStatus(msg) {
            console.log(msg);
            statusDiv.textContent = msg;
        }

        function showError(msg) {
            console.error(msg);
            errorDiv.textContent = '❌ ' + msg;
            clearTimeout(loadingTimeout);
        }

        // Timeout de sécurité
        loadingTimeout = setTimeout(() => {
            showError('Timeout: Vérifiez que le fichier targets-cpge.mind existe et est accessible');
        }, 15000);

        updateStatus('Vérification des ressources...');

        // Vérifier si le fichier .mind existe
        fetch('./assets/targets-cpge.mind')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Fichier targets-cpge.mind introuvable (${response.status})`);
                }
                updateStatus('Fichier .mind trouvé ✓');
                return response;
            })
            .catch(err => {
                showError('Fichier targets-cpge.mind introuvable. Vérifiez le chemin.');
            });

        // Attendre que la scène soit chargée
        const sceneEl = document.querySelector('a-scene');
        
        sceneEl.addEventListener('loaded', () => {
            updateStatus('Scène A-Frame chargée ✓');
        });

        // Démarrer MindAR après le chargement
        sceneEl.addEventListener('renderstart', () => {
            updateStatus('Initialisation MindAR...');
            
            const mindSystem = sceneEl.systems['mindar-image-system'];
            if (mindSystem) {
                mindSystem.start().then(() => {
                    clearTimeout(loadingTimeout);
                    updateStatus('MindAR démarré ✓');
                    
                    setTimeout(() => {
                        loadingScreen.style.display = 'none';
                        startAudio.style.display = 'flex';
                    }, 500);
                }).catch((err) => {
                    showError('Erreur MindAR: ' + err.message);
                });
            } else {
                showError('Système MindAR non trouvé');
            }
        });

        // Gestion du son
        startAudio.addEventListener('click', function () {
            ['#video1', '#video2', '#video3'].forEach(id => {
                const v = document.querySelector(id);
                if (v) {
                    v.muted = false;
                    v.play().then(() => {
                        v.pause();
                    }).catch((err) => {
                        console.warn('Erreur vidéo:', err);
                    });
                }
            });
            this.style.display = 'none';
        });

        // Log des erreurs
        window.addEventListener('error', (e) => {
            console.error('Erreur globale:', e.message);
        });
    </script>
</body>
</html>











                                    -->
